<!DOCTYPE html>

<head>
    <title>tacit.blue</title>

    <link rel="shortcut icon" href="assets/resources/favicon.ico">

    <link href='http://fonts.googleapis.com/css?family=Alegreya+Sans+SC:300,500,900italic|Alegreya+Sans:100,300,400,500,100italic,300italic,400italic,500italic' rel='stylesheet' type='text/css'>

    <link href="assets/css/lib/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="assets/css/sketch.css" rel="stylesheet" type="text/css"/>
    <link href="assets/css/index.css" rel="stylesheet" type="text/css"/>

    <script src="assets/js/lib/jquery-1.11.2.min.js"></script>
    <script src="assets/js/lib/bootstrap.min.js"></script>
    <script src="assets/js/lib/glpk.min.js"></script>
    <script src="assets/js/lib/d3.v2.min.js"></script>
    <script src="assets/js/lib/d3.cubehelix.js"></script>
    <script src="assets/js/lib/coffeescript.min.js"></script>

    <script src="assets/js/models/easel.js"></script>
    <script src="assets/js/models/sketch.js"></script>
    <script src="assets/js/models/structure.js"></script>
    <script src="assets/js/models/tools/select.js"></script>
    <script src="assets/js/models/tools/move.js"></script>
    <script src="assets/js/models/tools/draw.js"></script>
    <script src="assets/js/models/tools/erase.js"></script>
    <script src="assets/js/models/tools/load.js"></script>
    <script src="assets/js/models/tools/thicken.js"></script>
    <script src="assets/js/models/pad.js"></script>
    <script src="assets/js/models/suggestions.js"></script>
    <script src="assets/js/models/versions.js"></script>
    <script src="assets/js/models/undoredo.js"></script>

    <script src="assets/js/index.js"></script>
    <script src="assets/js/problems.js"></script>
    <script src="assets/js/controllers/toolbar.js"></script>
    <script src="assets/js/controllers/versions.js"></script>

    <script type="text/coffeescript">

    if location.hash[1] is "t"
        location.hash = location.hash.substr(2)
        gd = 1.7
        structure = new tacit.Structure
        new structure.Node({x:20, y:gd})
        new structure.Node({x:60, y:gd})
        new structure.Beam({x:20, y:60}, {x:60, y:60})
        structure.nodeList[i].fixed.y = true for i in [0,1]
        structure.nodeList[i].fixed.x = true for i in [0,1]
        structure.nodeList[i].force.x = 40 for i in [2,3]
        structure.nodeList[i].force.y = -10 for i in [2,3]
        node.immovable = true for node in structure.nodeList
        if location.hash.length < 6
            new structure.Beam({x:20, y:gd}, {x:20, y:60})
            new structure.Beam({x:60, y:gd}, {x:60, y:60})
            new structure.Beam({x:40, y:40}, {x:20, y:gd})
            new structure.Beam({x:40, y:40}, {x:60, y:gd})
            new structure.Beam({x:40, y:40}, {x:20, y:60})
            new structure.Beam({x:40, y:40}, {x:60, y:60})
        window.problem_description =
            title: "tutorial"
            text: "Let's build a quick scaffold."
        window.tutorial = true
    else if location.hash[1] is "n"
        location.hash = location.hash.substr(2)

    if location.hash[1] is "m"
        window.tool = {name: "manual", sized_beams: true, autocolor: false, showgrad: false}
        $("#featitle").css("display", "inherit")
        $("#colorbar").css("display", "inherit")
    else if location.hash[1] is "a"
        window.tool = {name: "auto", sized_beams: true, autocolor: true, showgrad: false}
        window.feapad = true
        $("#colorbar").css({display: "inherit", left: "1.5em", top: "18em", right: ""})
    else if location.hash[1] is "o"
        window.tool = {name: "optimal", sized_beams: false, autocolor: true, showgrad: true}
        window.feapad = true

    if not window.tutorial
        $("#tutorialpane").css("display", "none")
        if location.hash[2] is "b"
            structure = bridge()
        else if location.hash[2] is "s"
            structure = sign()
    else
        location.hash = "t"+location.hash.substr(1)

    window.triggers = {}
    initialize(structure)
    $("#introtitle").html(window.problem_description.title)
    $("#introtext").html(window.problem_description.text)

    if window.tutorial
        window.tutorialidx = if location.hash.length >= 6 then 0 else 8
        window.nextTutorialStep = ->
            window.tutorialidx++
            if window.tutorialidx <= window.tutorialsteps.length
                stephtml = "<span class='step'><p>"+window.tutorialsteps[window.tutorialidx-1].replace(/\n\n/gi, "\n<p>")+"</span>"
                if window.tutorialsteps[window.tutorialidx-1][0] isnt " "
                    stephtml = $("#steptext").append(stephtml)
                else
                    $("#steptext").html(stephtml)
                $("#stepname").text("step "+window.tutorialidx+" of "+window.tutorialsteps.length)
                return ""
            else
                location.hash = location.hash.substr(2)
                location.reload()

        goalweights = {optimal: 160, auto: 200, manual: 270}
        $("#goalweight").text("$"+goalweights[window.tool.name])

        window.upNext = ->
            console.log "upNext called"
            creationidx = window.tutorialidx - 1
            upOnlyRightAfterCreation = ->
                console.log [creationidx, window.tutorialidx]
                if window.tutorialidx is creationidx
                    window.nextTutorialStep()
            upOnlyRightAfterCreation()
            creationidx++
            return upOnlyRightAfterCreation

    window.tutorialsteps = ["""

    Welcome!

    This is the interface you'll be using to draw structures for the next problem.
    The <span style="color: #e14a4e; font-weight: 700;"> red arrows </span> show the load that your structure will have to support.

    The <span style="color: #2eabe2; font-weight: 700;"> blue triangles </span> are where your structure will anchor to the ground.

    Your task is to design the structure that will connect those<span style="color: #e14a4e; font-weight: 700;"> red circles </span> to the <span style="color: #2eabe2; font-weight: 700;"> blue triangles </span> to support the load.

    Your goal is to do so with the least possible material, as represented in the top bar by the cost to build your current structure.

    Because the loads are totally unsupported, the current cost is the rather expensive <span style="font-weight: 700;">$&infin;</span>.

    Let's fix that:
    <script> $("#draw-btn").addClass("tutorial_highlight")\<\/script\>

    <b>Click the <span style="color: #807ec7; font-weight: 700;">purple-outlined draw button</span> on the left.</b>
    <script> $("#draw-btn").click(upNext())\<\/script\>
    """,
    "
    Great! Now <b>draw a beam from an anchor to a load</b> by either clicking on one and then on the other or by dragging between them
    <script> $('#draw-btn').removeClass('tutorial_highlight')\<\/script\>
    <script> window.triggers.beam = upNext()\<\/script\>",
    # click the FEA button when you're ready to analyze it
    "Looks like the loads aren't fully supported yet. Dotted lines indicate a beam with no force, either because the loads aren't supported yet or because no forces go through that beam in supporting the load. They don't count towards the cost of your structure.

    \n\n<b>Draw a couple more beams</b> to create a working structure.
    #{if window.tool.name is "manual" then "\n\nTo analyze the structure, <b>click the ANALYZE button</b> in the left toolbar." else ""}
    <script> window.triggers.solve = upNext()\<\/script\>",
    "Neat, a working structure. Only saved designs count towards your goal. <b>Click the SAVE button in the left of the blue status bar at the top of the screen</b>.
    <script> window.triggers.save = upNext()\<\/script\>",
    """
    In the center of the status bar you can see the <b>cost</b> of your current structure. Cost is the sum of all beam's thicknesses times their lengths. You want this to be <i>as low as possible</i>.

    To the right of the cost is your <b>time limit</b>.

    <b> Click the eraser button to continue.</b>
    <script> $("#erase-btn").addClass("tutorial_highlight")\<\/script\>
    <script> $("#erase-btn").click(upNext())\<\/script\>""",
    "
    <script> $('#erase-btn').removeClass('tutorial_highlight')\<\/script\>
    <b>Click any diagonal beams you've drawn to erase them.</b>
    <script> window.triggers.erase = upNext()\<\/script\>",
    """
    You should have two vertical and one horizontal beam: <b>if not, draw them now</b>.

    To continue improving designs you'll often need to add <b>new nodes.</b>

    Nodes can be created in empty space or by adding a joint to an existing beam.

    <b>Create a beam from a corner to the empty space inside your current design.</b>
    <script> window.triggers.floatnode = upNext()\<\/script\>""",

    "Great! Now <b>connect that node to the other three corners</b> and then <b>save your design</b>
    <script> window.triggers.save = upNext()\<\/script\>",
    # TODO: cut the theory below?
    """#{if location.hash.length < 6 then "Welcome back! Let's get you up to speed on this new tool." else ""}

    A design consists of three things: the connections of beams, the positions of nodes, and the sizes of the beams. By #{if location.hash.length <6 then "making beams we've determined the first" else "making new beams you've altered the first"}, and now you can move the center node to change the second.

    <b>Click on the hand button.</b>
    <script> $('#move-btn').addClass('tutorial_highlight')\<\/script\>
    <script> $('#move-btn').click(upNext())\<\/script\>""",
    "
    <script> $('#move-btn').removeClass('tutorial_highlight')\<\/script\>
    <b>Move the node by clicking it and dragging</b>.
    <script> window.triggers.movenode = upNext()\<\/script\>",
    "#{if window.tool.sized_beams then "Now let's resize the beams. <b>Click a beam and drag away from it</b> and the beam will change size #{if window.tool.name is "manual" then "in the drawing pane; <b>click the ANALYZE button</b> to see its new stress in the analysis pane" else ""}.
    <script> window.triggers.resizebeam = upNext()\<\/script\>
    " else "<script>nextTutorialStep()\<\/script\>"}",
    "#{if not window.tool.autocolor then "Now <b>analyze your new structure</b>.
    <script> window.triggers.solve = upNext()\<\/script\>
    " else "<script>nextTutorialStep()\<\/script\>"}",
    """
     #{if window.tool.showgrad then "The <span style='color: #807ec7; font-weight: 700;'>purple arrow</span>
    you see while moving the node indicates the direction to move the node to decrease cost, and the amount that the cost would decrease if moved in that direction; it's another tool for you to use." else "The changing beam colors you see while resizing beams and moving nodes indicate the internal stress of those beams. Red and black beams are overloaded and need to be made larger to sustain their loads, while orange through blue beams are at least as strong as they need to be. A legend for these beams can be seen to the left under the STRESS heading.

    At the point of failure the color shifts dramatically: a beam that is fully loaded is <i>orange</i>, while one that is ever-so-slightly overloaded turns red as the structure fails."}

    To the left of the current cost is your <b>target cost</b>. To get your current structure to this target value will take some work.

    Move the node#{if window.tool.sized_beams then " and/or resize beams" else ""} until your cost is lower than the threshold, then <b>save</b>.
    <script> window.triggers.beat = upNext()\<\/script\>""",
    """
     Congratulations! Your saved design has met the starting goal, and the status bar will now tell you the cost of your <i>best saved design.</i>

    A few more tips (feel free to try them to the left):

    If you wanted to erase this design efficiently, you could erase the central node, as erasing a node erases all connected beams.

    If you then wanted to redraw it, you could draw a diagonal beam, and then draw a beam from a third corner to the center of that beam. Putting nodes into beams adds a pin joint to that beam, so such interrupted beams are quite different from straight ones.

    That's it for the tutorial! Click the finish button to proceed.
    """,
    ]

    cm = window.tacit.colormap
    height = 100
    window.delaytime = 10

    `
    var canvas = d3.select("#colorbar").append("canvas")
    .attr("width", 1)
    .attr("height", height)
    .style("width", 22 + "px")
    .style("height", height + "px")
    .each(function(d) {
      var context = this.getContext("2d"),
          image = context.createImageData(1, height);
      for (var i = 0, j = -1, c; i < height; ++i) {
        c = d3.rgb(cm(2 - 2 * i / (height - 1)));
        image.data[++j] = c.r;
        image.data[++j] = c.g;
        image.data[++j] = c.b;
        image.data[++j] = 255;
      }
      context.putImageData(image, 0, 0);
    });
    `

    </script>


</head>

<body>
<div id="project">
<nav class="navbar navbar-default navbar-fixed-top">
  <div id="NameView" class="container-fluid">
      <span style="
    position: absolute;
    width: 100%;
    text-align: center;
    color: white;
    font-weight: 300;
    font-size: 2em;
    top: 0.35em;
    padding-left: 4em;
">

<span id="weights"> <span id="goaltitle">goal</span> <span id="goalweight">$350</span> currently
  <span id="designweight"></span></span>

<div id="timer" style="display: inline-block; text-align: left; width: 170px;"></div></span>
    <ul class="nav navbar-nav navbar-left">
      <li>
        <div id="HistorySketchesView">
        </div>
      </li>
      <li>
        <a data-toggle="tooltip" data-placement="bottom" id="save-btn-wrapper">
          <button id="save-btn" type="button" type="button" class="notyet btn btn-default btn-lg" disabled title="(cmd-S)" data-toggle="tooltip" data-placement="bottom">SAVE</button>
        </a>
      </li>
    </ul>

    <ul class="nav navbar-nav navbar-right">
        <li>
          <a>
            <div id="undo-btn-group" class="btn-group" role="group" aria-label="..." title="(cmd-Z / cmd-Y)" data-toggle="tooltip" data-placement="bottom">
              <button id="undo-btn" type="button" class="notyet btn btn-default btn-lg" disabled>
                UNDO</span>
              </button>
              <button id="redo-btn" type="button" class="notyet btn btn-default btn-lg" disabled>
                REDO</span>
              </button>
            </div>
          </a>
       </li>
        <li>
          <a data-toggle="tooltip" data-placement="bottom">
            <button id="export-btn" type="button" class="notyet btn btn-default btn-lg" data-toggle="tooltip" data-placement="bottom">FINISH</button>
          </a>
        </li>
    </ul>

  </div>
</nav>

<div id="ProjectView" class="container-fluid">
    <div class="row">
    <div id="EaselView">
      <div id="ToolbarView" class="notyet col-xs-1">
        <button type="button" class="btn btn-default toolbar-btn" id="select-btn" data-toggle="tooltip" data-placement="right" title="Select" style="display:none">
            <img height="40px" width="40px" src="assets/resources/button-images/select.png"></button>
        <button type="button" class="btn btn-default toolbar-btn" id="move-btn" data-toggle="tooltip" data-placement="right" title="(M)ove">
            <img height="40px" src="assets/resources/button-images/move.png"></button>
        <button type="button" class="btn btn-default toolbar-btn" id="draw-btn" data-toggle="tooltip" data-placement="right" title="(D)raw">
            <img height="40px" src="assets/resources/button-images/draw.png"></button>
        <button type="button" class="btn btn-default toolbar-btn" id="erase-btn" data-toggle="tooltip" data-placement="right" title="(E)rase">
            <img height="40px" src="assets/resources/button-images/erase.png"></button>
        <button type="button" class="btn btn-default toolbar-btn" id="measure-btn" data-toggle="tooltip" data-placement="right" title="(M)easure" style="display:none;"> <img height="40px" src="assets/resources/button-images/measure.png"></button>
        <!--<button type="button" class="btn btn-default toolbar-btn" id="load-btn" data-toggle="tooltip" data-placement="right" title="(L)oad">
            <img height="40px" src="assets/resources/button-images/load.png"></button> -->

        <div style="margin-top: 25px; text-align: right;">
        <div id="textbtns" style="margin-top: 30px;">
            <button id="zoom-btn" type="button" class="btn btn-default toolbar-btn" data-toggle="tooltip" data-placement="right" title="show structure">ZOOM</button>
            <button id="fea-btn" type="button" class="btn btn-default toolbar-btn" data-toggle="tooltip" data-placement="right" title="analyze structure" style="font-size: 0.7em;">ANALYZE</button>
        </div>

<!--
        <div id="Options" style="margin-top: 20px; text-align: left;">
            <h2>
                <input type="radio" name="tool"
                 onclick="window.tool = {sized_beams: false, autocolor: true, showgrad: true}; window.updateTool()" checked> optimal <br>
                <input type="radio" name="tool"
                 onclick="window.tool =  {sized_beams: true, autocolor: true, showgrad: false}; window.updateTool()"> auto <br>
                <input type="radio" name="tool"
                 onclick="window.tool = {sized_beams: true, autocolor: false, showgrad: false}; window.updateTool()"> manual <br>
            </h2>
        </div> -->
<!--          <h2>
          <input type="checkbox" name="grid" value="hasGrid" checked="true"> grid <br>
          <input type="checkbox" name="baseLine" value="hasBaseLine" checked="true"> ground <br>
      </h2>-->

      </div>
  </div>



      <div id="PadView" class="col-xs-1">
      </div>
      <div id="FEAview" class="col-xs-1">
      </div>
      <div id="featitle" style="display: none; position: absolute; left: 50%; padding: 1em; font-size: 2em; opacity: 0.5; margin-left: 2em;"><h1>structural analysis</h1></div>
      <div id="colorbar" style="display: none;  position: absolute; right: 40px; padding: 1em;"><h2>stress</h2>
      <span style="float: left; font-size: 0.75em; padding-right: 5px;">
          <div style="margin-top: -6px;">2 &#x3c3; <sub>max</sub></div>
          <div style="padding-top: 24px;"> &#x3c3; <sub>max</sub></div>
          <div style="padding-top: 32px;">0</div>
      </span>
      </div>
      </div>
      <div id="tutorialpane" class="col-xs-1">
          <h1 id="stepname"></h1>
          <div id="steptext">
     </div></div>



    </div>

<svg xmlns="http://www.w3.org/2000/svg" width="0" height="0">

 <defs>
    <pattern id="smallGrid" width="10" height="10" patternUnits="userSpaceOnUse">
      <path d="M 10 0 L 0 0 0 10" fill="none" stroke="#3d3130" stroke-width="0.0625"/>
    </pattern>
    <pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
      <rect width="100" height="100" fill="url(#smallGrid)"/>
      <path d="M 100 0 L 0 0 0 100" fill="none" stroke="#3d3130" stroke-width="0.125"/>
    </pattern>
  </defs>
  <marker id="brtriangle" viewBox="0 0 10 10" refX="10" refY="5" markerUnits="strokeWidth" markerWidth="4" markerHeight="3" orient="auto" fill="#e14a4e">
      <path d="M 0 0 L 10 5 L 0 10 z"/>
  </marker>
  <marker id="ptriangle" viewBox="0 0 10 10" refX="7" refY="5" markerUnits="strokeWidth" markerWidth="4" markerHeight="3" orient="auto" fill="#807ec7">
      <path d="M 0 0 L 10 5 L 0 10 z"/>
  </marker>
</svg>


</div>
</div>
<div id="intro" onclick="$('#project').css('opacity', 1); $('#intro').css('opacity', 0).css('z-index', -10); setTimeout(function(){$('#intro').css('display', 'none');}, 500); startClock(); if (window.tutorial) {nextTutorialStep();}">
    <div id="introstuff">
    <h1 id="introtitle"></h1>

    <div id="introtext"></div>

    <div id="introhelp">click to begin</div>
</div>
</div>
</body>

</html>
